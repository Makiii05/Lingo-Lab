<!-- Register Learner Modal -->
<dialog id="register_learner_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box space-y-4">
        <div class="flex items-center space-x-1">
            <div class="flex justify-center items-center h-12 w-12 rounded-full bg-indigo-100">
                <i class="bi bi-person-add text-indigo-600 text-xl"></i>
            </div>
            <h2 class="text-lg font-bold">Register Learner</h2>
        </div>
        <hr>
        <form class="space-y-7" method="POST" action="{% url 'register-learner' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <label class="floating-label">
                <span>Learner's Name</span>
                <input name="name" required type="text" placeholder="First name, Middle name, Last name" 
                class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
            </label>
            <label class="floating-label">
                <span>Learner's Grade</span>
                <input name="grade" required type="text" placeholder="e.g. Grade 1, Grade 2â€¦" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
            </label>

            <!-- Learner Age Select -->
            <label class="form-control w-full floating-label">
                <span class="label-text">Learner's Age</span>
                <select name="age" required class="select w-full border border-neutral-300 p-3 rounded-lg ">
                    <option disabled selected>Select age</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                </select>
            </label>
            <fieldset  class="fieldset">
                <legend class="fieldset-legend">Pick an image</legend>
                <input name="profile_picture" type="file" accept="image/*" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                <label class="label">Max size 2MB</label>
            </fieldset>

            <button class="btn text-white bg-indigo-600 hover:bg-indigo-700 w-full mt-2">Register</button>
        </form>

        <div class="modal-action">
            <form method="dialog" class="w-full">
                <button class="btn border rounded border-slate-200 w-full">Cancel</button>
            </form>
        </div>
    </div>
</dialog>
<dialog id="quiz_me_now_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box space-y-4">
        <div class="flex items-center space-x-1">
            <div class="flex justify-center items-center h-12 w-12 rounded-full bg-purple-100">
                <i class="bi bi-book text-purple-600 text-xl"></i>
            </div>
            <h2 class="text-lg font-bold">Create Quiz</h2>
        </div>
        <hr>
            <input name="learner_id" class="quiz-input" required type="hidden" value="">
            <label class="form-control w-full floating-label">
                <span class="label-text">Language</span>
                <select name="language" required class="select w-full border border-neutral-300 p-3 rounded-lg  quiz-input">
                    <option disabled selected>Select Language</option>
                    <option value="english">English</option>
                    <option value="tagalog">Tagalog</option>
                </select>
            </label>
            <label class="form-control w-full floating-label">
                <span class="label-text">Type</span>
                <select name="type" required class="select w-full border border-neutral-300 p-3 rounded-lg  quiz-input">
                    <option disabled selected>Select Type</option>
                    <option value="words">Words</option>
                    <option value="sentences">Sentences</option>
                </select>
            </label>
            <label class="floating-label">
                <span>Number of Question</span>
                <input name="no_of_question" required type="number" placeholder="Number of question" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent quiz-input" />
            </label>
            <label class="floating-label">
                <span>Word's Length</span>
                <input name="words_length" required type="number" placeholder="Word's Length (0 if sentence type)" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent quiz-input" />
            </label>
            <button class="btn text-white bg-indigo-600 hover:bg-indigo-700 w-full mt-2" id="generate_qr_code_button">Generate QR Code</button>
        <div class="modal-action">
            <form method="dialog" class="w-full">
                <button class="btn border rounded border-slate-200 w-full">Cancel</button>
            </form>
        </div>
    </div>
</dialog>
<dialog id="generate_qr_code_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box space-y-4">
        <div class="flex items-center space-x-1">
            <div class="flex justify-center items-center h-12 w-12 rounded-full bg-green-100">
                <i class="bi bi-play text-green-600 text-xl"></i>
            </div>
            <h2 class="text-lg font-bold">Scan QR Code</h2>
        </div>
        <hr>
        <div class="flex flex-col items-center">
            <div class="w-48 h-48 bg-slate-200 flex items-center justify-center rounded-lg">
                <img id="QrCodeEl" src="" alt="QR Placeholder" class="w-48 h-48 rounded-lg" />
            </div>
            <p class="mt-2 text-sm text-gray-500">
                Ask the student to scan this code with their device.
            </p>
            <form action="{% url 'quiz-me-scoring' %}" method="POST" class="w-full">
                {% csrf_token %}
                <input type="hidden" name="quiz_data" id="quiz_data_input" value=''>
                <button class="btn text-white bg-indigo-600 hover:bg-indigo-700 w-full mt-3" type="submit">Proceed</button>
            </form>
        </div>
        <div class="modal-action">
            <form method="dialog" class="w-full">
                <button class="btn border rounded border-slate-200 w-full">Cancel</button>
            </form>
        </div>
    </div>
</dialog>
<dialog id="view_comments_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box space-y-4">
        <div class="flex items-center space-x-1">
            <div class="flex justify-center items-center h-12 w-12 rounded-full bg-green-100">
                <i class="bi bi-play text-green-600 text-xl"></i>
            </div>
            <h2 class="text-lg font-bold">Mentor's Comment</h2>
        </div>
        <hr>
        <div id="comment-container" class="">

        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
</dialog>
<dialog id="view_final_score_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box space-y-4 max-w-4xl bg-slate-50">
        <div class="flex items-center space-x-1">
            <div class="flex justify-center items-center h-12 w-12 rounded-full bg-green-100">
                <i class="bi bi-play text-green-600 text-xl"></i>
            </div>
            <h2 class="text-lg font-bold">Review Overall Scores and Information</h2>
        </div>
        <hr>
        <div id="comment-container" class="">
            <form class="space-y-7" method="POST" action="{% url 'submit-score' %}">
                {% csrf_token %}
                <div class="relative mb-6">
                    <div class="h-px bg-slate-200 w-full"></div>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-50 px-2 text-slate-400 text-xs uppercase font-medium tracking-wider">
                        Quiz Information
                    </span>
                </div>
                <div class="grid grid-cols-3 gap-6">
                    <label class="floating-label">
                        <span>Learner's Id</span>
                        <input name="id" type="text" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Type</span>
                        <input name="type" type="text" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Quiz Item</span>
                        <input name="number_of_questions" type="text" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Word Length</span>
                        <input name="final_words_length" type="text" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Language</span>
                        <input name="quiz_language" type="text" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Total Words</span>
                        <input name="total_words" type="text" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                </div>
                <div class="relative mb-6">
                    <div class="h-px bg-slate-200 w-full"></div>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-50 px-2 text-slate-400 text-xs uppercase font-medium tracking-wider">
                        Miscues
                    </span>
                </div>
                <div class="grid grid-cols-4 gap-6">
                    <label class="floating-label">
                        <span>Stutters</span>
                        <input name="stutter_score" type="number" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Repitition</span>
                        <input name="repetition_score" type="number" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Pause</span>
                        <input name="pause_score" type="number" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Mispronunciation</span>
                        <input name="pronunciation_score" type="number" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                </div>
                <div class="relative mb-6">
                    <div class="h-px bg-slate-200 w-full"></div>
                    <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-50 px-2 text-slate-400 text-xs uppercase font-medium tracking-wider">
                        Overall Scores
                    </span>
                </div>
                <div class="grid grid-cols-3 gap-6">
                    <label class="floating-label">
                        <span>Fluency (for word quiz)</span>
                        <input name="correctness_score" type="number" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Word Per Minute (for sentence quiz)</span>
                        <input name="speed_score" type="number" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                    <label class="floating-label">
                        <span>Overall Score (DO 14 - Phil IRI )</span>
                        <input name="overall_score" type="number" readonly value="" class="input input-md w-full border border-neutral-300 p-3 rounded-lg focus:placeholder-transparent" />
                    </label>
                </div>
                <textarea readonly name="quiz_comments" rows="4" class="mt-1 block w-full border border-slate-300 rounded-xl shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </textarea>
                <button class="btn text-white bg-indigo-600 hover:bg-indigo-700 w-full mt-2">Submit Score</button>
            </form>
        </div>
        <div class="modal-action w-full">
            <form method="dialog" class="w-full">
                <button class="btn w-full">Close</button>
            </form>
        </div>
    </div>
</dialog>
<script>
    async function generate_word(number, length, language){
        if(language === 'tagalog'){
            resp = await fetch(`get-tagalog-word/${length}/${number}`);
            const data = await resp.json();
            return data["question"];
        }else{
            const response = await fetch(`https://random-word-api.herokuapp.com/word?number=${number}&length=${length}`);
            const data = await response.json();
            return data;
        }
    }

    async function generate_sentence(number, language){
        const resp = await fetch(`get-sentences/${number}/${language}`);
        const data = await resp.json();
        return data['question']; 
    }

    async function generate_qr_function(data){
        const jsonData = JSON.stringify(data);
        return ` https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${jsonData}`
    }

    document.querySelector('#generate_qr_code_button').addEventListener('click', async function(event) {
        let hasEmpty = false;
        data = {};

        document.querySelectorAll('.quiz-input').forEach(input => {
            if (!input.value || input.value === "" || input.value === "Select Language" || input.value === "Select Type") {
                input.classList.add('border-red-500');
                input.classList.remove('border-neutral-300');
                event.preventDefault();
                hasEmpty = true;
                return;
            }else{
                input.classList.remove('border-red-500');
                input.classList.add('border-neutral-300');
            }
        });

        if (!hasEmpty) {
            document.querySelectorAll('.quiz-input').forEach(input => {
                data[input.name] = input.value;
            });
            if(data['type'] === 'sentences'){
                data["question"] = await generate_sentence(
                    data['no_of_question'], 
                    data['language']
                );
            }else{
                data["question"] = await generate_word(
                    data['no_of_question'], 
                    data['words_length'], 
                    data['language']
                );  
            }
            document.getElementById("QrCodeEl").src = await generate_qr_function(data)
            console.log(data)
            document.getElementById('quiz_data_input').value = JSON.stringify(data);
            document.getElementById('generate_qr_code_modal').showModal();
        }    
    });
</script>