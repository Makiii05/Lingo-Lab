{% extends 'Lingolab/components/layout.html' %}

{% block body %}
    <style>
        .carousel-item {
            display: none;
        }
        .carousel-item:target {
            display: flex !important;
        }
    </style>
    <div class="flex gap-6">
    
    <!-- LEFT: SCORING (scrollable) -->
    <div class="flex-1 h-85vh overflow-y-auto pr-3 space-y-6">
        <h1 class="text-2xl font-bold text-slate-900">Session Scoring</h1>

        <div class="bg-white rounded-xl shadow-lg border border-slate-100">
            <div class="p-6">
                <!-- Carousel Container -->
                <div class="carousel w-full rounded-lg overflow-hidden">
                    {% for item in data.question %}
                    <div id="item{{forloop.counter}}" class="carousel-item w-full">
                        <div class="w-full p-6 bg-slate-50 border border-slate-200 rounded-xl">
                            <h3 class="text-lg font-semibold text-indigo-600 mb-4">
                                {{forloop.counter}}. 
                                <span class="font-bold">{{ item|title }}</span>
                                {% if data.type == "words" %}
                                <i class="bi bi-volume-up-fill ml-2 cursor-pointer hover:text-indigo-700" onclick="getAudio('{{ item }}')"></i>
                                {% endif %}
                            </h3>
                            <div class="grid grid-cols-1 gap-6">
                                {% if data.type == "sentences" %}
                                <div class="place-self-center">
                                    <label class="block text-sm font-medium text-slate-700 mb-1 text-center">Word Per Minute (Auto Fill)</label>
                                    <input type="text" readonly name="wpm{{forloop.counter}}" 
                                        class="wpm_input mt-1 block w-full border border-slate-300 rounded-xl shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                        placeholder="Calculate through Learner" />
                                </div>
                                {% else %}
                                <div class="place-self-center">
                                    <label class="block text-sm font-medium text-slate-700 mb-1 text-center">Fluency</label>
                                    <div class="flex gap-3">
                                        <label class="cursor-pointer">
                                            <input type="radio" checked name="correctness{{forloop.counter}}" value="4" required class="peer sr-only" />
                                            <div class="w-8 h-8 flex items-center justify-center rounded-lg border text-xs font-semibold text-center peer-checked:bg-green-600 peer-checked:text-white transition-all duration-150">4</div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="correctness{{forloop.counter}}" value="3" class="peer sr-only" />
                                            <div class="w-8 h-8 flex items-center justify-center rounded-lg border text-xs font-semibold text-center peer-checked:bg-green-600 peer-checked:text-white transition-all duration-150">3</div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="correctness{{forloop.counter}}" value="2" class="peer sr-only" />
                                            <div class="w-8 h-8 flex items-center justify-center rounded-lg border text-xs font-semibold text-center peer-checked:bg-green-600 peer-checked:text-white transition-all duration-150">2</div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="correctness{{forloop.counter}}" value="1" class="peer sr-only" />
                                            <div class="w-8 h-8 flex items-center justify-center rounded-lg border text-xs font-semibold text-center peer-checked:bg-green-600 peer-checked:text-white transition-all duration-150">1</div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="correctness{{forloop.counter}}" value="0" class="peer sr-only" />
                                            <div class="w-8 h-8 flex items-center justify-center rounded-lg border text-xs font-semibold text-center peer-checked:bg-green-600 peer-checked:text-white transition-all duration-150">0</div>
                                        </label>
                                    </div>
                                </div>
                                {% endif %}
                                <hr>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    <div class="place-items-center grid grid-cols-1 gap-1">
                                        <label class="block text-sm font-medium text-slate-700">Mispronunciation</label>
                                        <input type="number" name="pronunciation" min="0" value="0" bs-data-type="pronunciation"
                                            class="stutters_input mt-1 block w-full border border-slate-300 rounded-xl shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <button class="plus w-full h-12 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition-colors duration-200 shadow-sm">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <button class="minus w-full rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors duration-200 shadow-sm">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                    </div>
                                    <div class="place-items-center grid grid-cols-1 gap-1">
                                        <label class="block text-sm font-medium text-slate-700">Stutters</label>
                                        <input type="number" name="stutters" min="0" value="0" bs-data-type="stutters"
                                            class="stutters_input mt-1 block w-full border border-slate-300 rounded-xl shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <button class="plus w-full h-12 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition-colors duration-200 shadow-sm">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <button class="minus w-full rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors duration-200 shadow-sm">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                    </div>
                                    <div class="place-items-center grid grid-cols-1 gap-1">
                                        <label class="block text-sm font-medium text-slate-700">Repetition</label>
                                        <input type="number" name="repetition" min="0" value="0" bs-data-type="repetition"
                                            class="repetition_input mt-1 block w-full border border-slate-300 rounded-xl shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <button class="plus w-full h-12 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition-colors duration-200 shadow-sm">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <button class="minus w-full rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors duration-200 shadow-sm">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                    </div>
                                    <div class="place-items-center grid grid-cols-1 gap-1">
                                        <label class="block text-sm font-medium text-slate-700">Pause</label>
                                        <input type="number" name="pause" min="0" value="0" bs-data-type="pause"
                                            class="repetition_input mt-1 block w-full border border-slate-300 rounded-xl shadow-sm py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <button class="plus w-full h-12 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition-colors duration-200 shadow-sm">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <button class="minus w-full rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors duration-200 shadow-sm">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between w-full mt-4">
                                
                                {% if forloop.counter != 1 %}
                                <a href="#item{{forloop.counter|add:-1}}" class="btn btn-sm btn-outline hover:btn-primary hover:text-white">Previous</a>                                    
                                {% endif %}
                                <a href="#item{{forloop.counter|add:1}}" class="btn btn-sm btn-outline hover:btn-primary hover:text-white ms-auto">Next</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <div id="item{{data.question|length|add:1}}" class="carousel-item w-full">
                        <div class="w-full p-6 bg-slate-50 border border-slate-200 rounded-xl">
                            <h3 class="text-lg font-semibold text-indigo-600 mb-4">Summary & Comments</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="comments" class="block text-sm font-medium text-slate-700">Mentor's Comments</label>
                                    <textarea id="comments" rows="6"
                                        class="mt-1 block w-full border border-slate-300 rounded-xl shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                        placeholder="Additional observations..."></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 pt-4">
                                <button type="button" onclick="window.history.back()" class="inline-flex justify-center py-2 px-4 border border-slate-300 shadow-sm text-sm font-medium rounded-xl text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                    Cancel
                                </button>
                                <button id="view_score_button"  class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                    Review Score
                                </button>
                            </div>
                            <div class="flex justify-start w-full mt-4">
                                <a href="#item{{data.question|length}}" class="btn btn-sm btn-outline hover:btn-primary hover:text-white">Previous</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- RIGHT: INFO PANEL + LIVE SCORE (sticky) -->
    <div class="hidden md:block w-80">
        <div class="sticky top-6 space-y-4 text-xs">
            <!-- Quiz Info -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-100 p-4">
                <h3 class="text-lg font-semibold text-slate-900 mb-2">Quiz Info</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-slate-500">Learner's Id</p>
                        <p class="font-medium text-slate-900">{{data.learner_id}}</p>
                    </div>
                    <div class="space-y-3 grid grid-cols-2">
                        <div>
                            <p class="text-sm text-slate-500">Language</p>
                            <p class="font-medium text-slate-900">{{data.language|title}}</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Total Items</p>
                            <p class="font-medium text-slate-900">{{data.no_of_question}}</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Quiz Type</p>
                            <p class="font-medium text-slate-900">{{data.type|title}} Quiz</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Word Length </p>
                            <p class="font-medium text-slate-900">{{data.words_length}}</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Session Date</p>
                            <p class="font-medium text-slate-900">{{now|date:"F j, Y"}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Score -->
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl shadow-lg border border-indigo-200 p-3">
                {% if data.type == "sentences" %}
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-indigo-900">WPM</h3>
                    <p class="text-xl font-bold" id="wpm_el"></p>
                    <p class="text-xl font-bold hidden" id="correctness_el"></p>
                </div>
                {% elif data.type == "words" %}
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-indigo-900">Fluency</h3>
                    <p class="text-xl font-bold" id="correctness_el"></p>
                    <p class="text-xl font-bold hidden" id="wpm_el"></p>
                </div>
                {% endif %}
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-indigo-900">Overall Score (Phil IRI) <i class="bi bi-question-circle" title="DEPED ORDER 14, S.2018 |  (no_words - miscues/no_words) * 100"></i></h3>
                    <p class="text-xl font-bold" id="overall_score_el"></p>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-indigo-700">Pronunciation</p>
                        <p class="text-xl font-bold" id="pronunciation_el"></p>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-indigo-700">Stutters</p>
                        <p class="text-xl font-bold text-indigo-900" id="stutters_el"></p>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-indigo-700">Repitition</p>
                        <p class="text-xl font-bold text-indigo-900" id="repetition_el"></p>
                    </div>
                    <div class="flex justify-between items-center">
                        <p class="text-sm text-indigo-700">Pauses</p>
                        <p class="text-xl font-bold" id="pauses_el"></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

<script>
    document.querySelectorAll(".carousel-item")[0].style.display = "flex"
    // print this all
    let learner_id = "{{ data.learner_id }}";
    let language = "{{ data.language }}";
    let quiz_type = "{{ data.type }}";
    let no_of_question = "{{ data.no_of_question }}";
    let words_length = "{{ data.words_length }}";
    let date = new Date().toLocaleDateString("en-US", {month: "long", day: "numeric", year: "numeric",});
    let wpm = 0;
    let correctness = 0;
    let pronunciation = 0;
    let pauses = 0;
    let stutters = 0;
    let repetition = 0;
    let score = 0;
    let total_words = 0;
    let comment = "";

    let sentences = ["{{data.question}}"];
    sentences.forEach(sentence => {
        total_words += sentence.trim().split(/\s+/).length;
    });

    async function getAudio(word) {
        try {
            const resp = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await resp.json();
            const phonetics = data[0]?.phonetics || [];
            let audioUrl = "";
            for (let p of phonetics) {
                if (p.audio) {
                    audioUrl = p.audio;
                    break;
                }
            }
            if (!audioUrl) {
                alert("No pronunciation audio found for: " + word);
                return;
            }
            const audio = new Audio(audioUrl);
            audio.play();
        } catch (err) {
            console.error(err);
            alert("Error retrieving audio.");
        }
    }

    function initializeMiscuesButtons() {
        document.querySelectorAll(".place-items-center").forEach((container) => {
            const input = container.querySelector('input[type="number"]');
            const plusBtn = container.querySelector(".plus");
            const minusBtn = container.querySelector(".minus");
            
            if (input && plusBtn && minusBtn) {
                plusBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    let currentValue = parseInt(input.value) || 0;
                    input.value = currentValue + 1;
                    updateOverallScore(input.getAttribute("bs-data-type"), +1);
                });
                
                minusBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    let currentValue = parseInt(input.value) || 0;
                    if (currentValue > 0) {
                        input.value = currentValue - 1;
                        updateOverallScore(input.getAttribute("bs-data-type"), -1);
                    }
                });
            }
        });
    }

    //detect changes in radio the call updateOverallScore
    document.querySelectorAll('input[type="radio"]').forEach((radio) => {
        radio.addEventListener("change", () => {
            updateOverallScore();
        });
    });

    function updateOverallScore(element=null, value=null){
        if (element === "pronunciation") {
            pronunciation += value;
        } else if (element === "stutters") {
            stutters += value;
        } else if (element === "repetition") {
            repetition += value;
        } else if (element === "pause") {
            pauses += value;
        }

        // implement here the calculation of fluency. max point is 4. get all radio buttons selected values and calculate its average
        if (quiz_type === "words") {
            let totalCorrectness = 0;
            let totalItems = 0;
            document.querySelectorAll('input[name^="correctness"]').forEach((radio) => {
                if (radio.checked) {
                    totalCorrectness += parseInt(radio.value);
                    totalItems += 1;
                }
            });
            // calculate as percentage: (total score / (number of items * 4)) * 100
            correctness = totalItems > 0 ? Math.round((totalCorrectness / (totalItems * 4)) * 100) : 0;
        }

        //calc overall score
        let miscues = pronunciation + stutters + repetition + pauses;
        if (miscues <= total_words) {
            score = Math.round(((total_words - miscues) / total_words) * 100);
        }

        document.getElementById("overall_score_el").innerText = score;
        document.getElementById("wpm_el").innerText = wpm;
        document.getElementById("correctness_el").innerText = correctness + "%";
        document.getElementById("pronunciation_el").innerText = pronunciation;
        document.getElementById("pauses_el").innerText = pauses;
        document.getElementById("stutters_el").innerText = stutters;
        document.getElementById("repetition_el").innerText = repetition;
    }

    document.getElementById("view_score_button").addEventListener("click", () => {
        // Fill in quiz information
        document.querySelector('input[name="id"]').value = learner_id;
        document.querySelector('input[name="type"]').value = quiz_type;
        document.querySelector('input[name="number_of_questions"]').value = no_of_question;
        document.querySelector('input[name="final_words_length"]').value = words_length;
        document.querySelector('input[name="quiz_language"]').value = language.charAt(0).toUpperCase() + language.slice(1);
        document.querySelector('input[name="total_words"]').value = total_words;

        // Fill in miscues
        document.querySelector('input[name="stutter_score"]').value = stutters;
        document.querySelector('input[name="repetition_score"]').value = repetition;
        document.querySelector('input[name="pause_score"]').value = pauses;
        document.querySelector('input[name="pronunciation_score"]').value = pronunciation;

        // Fill in overall scores
        document.querySelector('input[name="correctness_score"]').value = correctness;
        document.querySelector('input[name="speed_score"]').value = wpm;
        document.querySelector('input[name="overall_score"]').value = score;

        // Fill in comments
        document.querySelector('textarea[name="quiz_comments"]').value = document.getElementById("comments").value;

        document.getElementById("view_final_score_modal").showModal()
    });

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", () => {
        updateOverallScore()
        initializeMiscuesButtons()
    });
</script>
{% endblock body %}
